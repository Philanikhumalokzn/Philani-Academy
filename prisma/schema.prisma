generator client {
  provider = "prisma-client-js"
}

datasource db {
  // Switched to Postgres for production (serverless-friendly hosted DB)
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Grade {
  GRADE_8
  GRADE_9
  GRADE_10
  GRADE_11
  GRADE_12
}

model User {
  id        String  @id @default(cuid())
  name      String?
  firstName String  @default("")
  lastName  String  @default("")
  middleNames String?
  email     String  @unique
  password  String
  role      String  @default("student")
  grade     Grade?
  avatar    String?
  dateOfBirth DateTime?
  phoneNumber String @default("")
  emailVerifiedAt DateTime?
  phoneVerifiedAt DateTime?
  alternatePhone String?
  recoveryEmail String?
  emergencyContactName String @default("")
  emergencyContactRelationship String?
  emergencyContactPhone String @default("")
  addressLine1 String @default("")
  addressLine2 String?
  city       String @default("")
  province   String @default("")
  postalCode String @default("")
  country    String @default("South Africa")
  schoolName String @default("")
  idNumber   String?
  consentToPolicies Boolean @default(false)
  consentTimestamp DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  verifications ContactVerification[]
  subscription UserSubscription?
}

model UserSubscription {
  id          String   @id @default(cuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  provider    String   @default("payfast")
  planId      String?
  status      String   @default("inactive")
  activeUntil DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([status])
  @@index([activeUntil])
}

model SessionRecord {
  id        String   @id @default(cuid())
  title     String
  description String?
  joinUrl   String
  startsAt  DateTime
  grade     Grade
  jitsiPassword String?
  jitsiActive   Boolean @default(false)
  createdBy String
  createdAt DateTime @default(now())
  materials LessonMaterial[]
}

model Announcement {
  id        String   @id @default(cuid())
  title     String
  content   String
  grade     Grade
  createdBy String?
  createdAt DateTime @default(now())
}

model LessonMaterial {
  id          String   @id @default(cuid())
  sessionId   String
  session     SessionRecord @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  title       String
  filename    String
  url         String
  contentType String?
  size        Int?
  createdBy   String?
  createdAt   DateTime @default(now())
}

model LatexSave {
  id         String   @id @default(cuid())
  sessionKey String
  userId     String?
  userEmail  String?
  title      String
  latex      String
  shared     Boolean  @default(false)
  filename   String?
  url        String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([sessionKey])
  @@index([sessionKey, userId])
}

model SubscriptionPlan {
  id            String   @id @default(cuid())
  name          String
  amount        Int
  currency      String   @default("zar")
  stripePriceId String?
  payfastPlanId String?
  active        Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

enum VerificationKind {
  EMAIL
  PHONE
}

model ContactVerification {
  id         String            @id @default(cuid())
  userId     String
  user       User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  kind       VerificationKind
  tokenHash  String            @unique
  expiresAt  DateTime
  consumedAt DateTime?
  createdAt  DateTime          @default(now())
}
