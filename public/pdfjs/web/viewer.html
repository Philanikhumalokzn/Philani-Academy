<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>PDF Viewer</title>
    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        background: #f5f6f7;
        overflow: hidden;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      }

      #container {
        width: 100%;
        height: 100%;
        overflow: auto;
        overscroll-behavior: contain;
      }

      #viewer {
        padding: 12px 0 24px;
      }

      .page {
        width: fit-content;
        margin: 0 auto 12px;
        background: #fff;
        box-shadow: 0 1px 6px rgba(0, 0, 0, 0.18);
      }

      .page canvas {
        display: block;
      }

      #status {
        position: fixed;
        inset: 0;
        display: grid;
        place-items: center;
        color: #5b5f66;
        font-size: 14px;
        background: #f5f6f7;
      }
    </style>
  </head>
  <body>
    <div id="status">Loading PDFâ€¦</div>
    <div id="container" aria-label="PDF container">
      <div id="viewer" aria-label="PDF document"></div>
    </div>

    <script type="module">
      import * as pdfjsLib from '/pdfjs/build/pdf.mjs'

      const params = new URLSearchParams(window.location.search)
      const file = params.get('file')

      const hashParams = new URLSearchParams((window.location.hash || '').replace(/^#/, ''))
      const initialPage = Math.max(1, Number(hashParams.get('page') || '1') || 1)
      const initialZoomPercent = Math.min(400, Math.max(50, Number(hashParams.get('zoom') || '110') || 110))

      const statusEl = document.getElementById('status')
      const container = document.getElementById('container')
      const viewer = document.getElementById('viewer')

      pdfjsLib.GlobalWorkerOptions.workerSrc = '/pdfjs/build/pdf.worker.min.mjs'

      const app = {
        pdfViewer: {
          currentPageNumber: initialPage,
          currentScaleValue: initialZoomPercent,
          container,
          _pages: [],
        },
      }

      Object.defineProperty(app, 'page', {
        get() {
          return app.pdfViewer.currentPageNumber
        },
        set(value) {
          const page = Math.max(1, Math.min(Number(value) || 1, app.pdfViewer._pages.length || 1))
          app.pdfViewer.currentPageNumber = page
          const target = app.pdfViewer._pages[page - 1]
          if (target?.div) {
            container.scrollTop = Math.max(0, target.div.offsetTop - 8)
          }
        },
      })

      window.PDFViewerApplication = app

      function showError(message) {
        if (statusEl) statusEl.textContent = message
      }

      if (!file) {
        showError('Missing PDF file URL.')
      } else {
        const scale = initialZoomPercent / 100
        const loadingTask = pdfjsLib.getDocument(file)

        loadingTask.promise
          .then(async (pdfDoc) => {
            const pages = []
            for (let pageNumber = 1; pageNumber <= pdfDoc.numPages; pageNumber += 1) {
              const pdfPage = await pdfDoc.getPage(pageNumber)
              const viewport = pdfPage.getViewport({ scale })

              const div = document.createElement('div')
              div.className = 'page'
              div.dataset.pageNumber = String(pageNumber)

              const canvas = document.createElement('canvas')
              const context = canvas.getContext('2d')
              if (!context) throw new Error('Canvas rendering context unavailable')

              canvas.width = Math.floor(viewport.width)
              canvas.height = Math.floor(viewport.height)
              div.appendChild(canvas)
              viewer.appendChild(div)

              await pdfPage.render({ canvasContext: context, viewport }).promise

              pages.push({ canvas, div })
            }

            app.pdfViewer._pages = pages
            app.pdfViewer.currentScaleValue = initialZoomPercent

            if (statusEl) statusEl.remove()
            app.page = initialPage

            const observer = new IntersectionObserver(
              (entries) => {
                let best = null
                for (const entry of entries) {
                  if (!entry.isIntersecting) continue
                  if (!best || entry.intersectionRatio > best.intersectionRatio) best = entry
                }
                if (best?.target?.dataset?.pageNumber) {
                  const page = Number(best.target.dataset.pageNumber)
                  if (Number.isFinite(page) && page > 0) {
                    app.pdfViewer.currentPageNumber = page
                  }
                }
              },
              {
                root: container,
                threshold: [0.25, 0.5, 0.75],
              }
            )

            for (const page of pages) observer.observe(page.div)
          })
          .catch((error) => {
            console.error(error)
            showError('Failed to load PDF.')
          })
      }
    </script>
  </body>
</html>