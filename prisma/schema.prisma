generator client {
  provider = "prisma-client-js"
}

datasource db {
  // Switched to Postgres for production (serverless-friendly hosted DB)
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Grade {
  GRADE_8
  GRADE_9
  GRADE_10
  GRADE_11
  GRADE_12
}

model User {
  id        String  @id @default(cuid())
  name      String?
  firstName String  @default("")
  lastName  String  @default("")
  middleNames String?
  email     String  @unique
  password  String
  role      String  @default("student")
  grade     Grade?
  avatar    String?
  dateOfBirth DateTime?
  phoneNumber String @default("")
  emailVerifiedAt DateTime?
  phoneVerifiedAt DateTime?
  alternatePhone String?
  recoveryEmail String?
  emergencyContactName String @default("")
  emergencyContactRelationship String?
  emergencyContactPhone String @default("")
  addressLine1 String @default("")
  addressLine2 String?
  city       String @default("")
  province   String @default("")
  postalCode String @default("")
  country    String @default("South Africa")
  schoolName String @default("")
  idNumber   String?
  consentToPolicies Boolean @default(false)
  consentTimestamp DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  verifications ContactVerification[]
  subscription UserSubscription?
  learnerResponses LearnerResponse[]
  assignmentResponses AssignmentResponse[]
}

model UserSubscription {
  id          String   @id @default(cuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  provider    String   @default("payfast")
  planId      String?
  status      String   @default("inactive")
  activeUntil DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([status])
  @@index([activeUntil])
}

model AppSetting {
  key       String   @id
  value     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model SessionRecord {
  id        String   @id @default(cuid())
  title     String
  description String?
  joinUrl   String
  startsAt  DateTime
  endsAt    DateTime
  grade     Grade
  jitsiPassword String?
  jitsiActive   Boolean @default(false)
  createdBy String
  createdAt DateTime @default(now())
  materials LessonMaterial[]
  assignments Assignment[]
  lessonScript SessionLessonScript?
}

model Assignment {
  id                String   @id @default(cuid())
  sessionId          String
  session            SessionRecord @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  title              String
  sourceUrl          String?
  sourceContentType  String?
  sourceFilename     String?
  createdBy          String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  questions          AssignmentQuestion[]
  responses          AssignmentResponse[]

  @@index([sessionId])
  @@index([sessionId, createdAt])
}

model AssignmentQuestion {
  id            String   @id @default(cuid())
  assignmentId  String
  assignment    Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  order         Int
  latex         String
  points        Int?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  responses      AssignmentResponse[]

  @@unique([assignmentId, order])
  @@index([assignmentId, order])
}

model AssignmentResponse {
  id           String   @id @default(cuid())
  sessionId     String
  assignmentId  String
  questionId    String
  userId        String
  userEmail     String?
  latex         String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  assignment    Assignment       @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  question      AssignmentQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)
  user          User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([questionId, userId])
  @@index([sessionId])
  @@index([assignmentId, userId, updatedAt])
  @@index([questionId, updatedAt])
}

model LessonScriptTemplate {
  id              String   @id @default(cuid())
  title           String
  grade           Grade?
  subject         String?
  topic           String?
  createdBy       String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  versions        LessonScriptVersion[]

  // Points to the version currently used by default.
  currentVersionId String?
  currentVersion   LessonScriptVersion? @relation("CurrentLessonScriptVersion", fields: [currentVersionId], references: [id])

  sessionAssignments SessionLessonScript[]

  @@index([grade])
}

model LessonScriptVersion {
  id          String   @id @default(cuid())
  templateId  String
  template    LessonScriptTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  // Incrementing version number per template.
  version     Int
  content     Json
  createdBy   String?
  createdAt   DateTime @default(now())

  // Back-reference for the template's currentVersion pointer.
  currentFor  LessonScriptTemplate[] @relation("CurrentLessonScriptVersion")

  // Back-reference for session assignments pinned to a specific version.
  sessionAssignments SessionLessonScript[] @relation("SessionLessonScriptVersion")

  @@unique([templateId, version])
  @@index([templateId])
}

model SessionLessonScript {
  id               String   @id @default(cuid())
  sessionId        String   @unique
  session          SessionRecord @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  templateId       String?
  template         LessonScriptTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)

  templateVersionId String?
  templateVersion   LessonScriptVersion? @relation("SessionLessonScriptVersion", fields: [templateVersionId], references: [id], onDelete: SetNull)

  // Optional full override content (stored as JSON). If set, it becomes the resolved script.
  overrideContent  Json?

  createdBy        String?
  updatedBy        String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([templateId])
  @@index([templateVersionId])
}

model Announcement {
  id        String   @id @default(cuid())
  title     String
  content   String
  grade     Grade
  createdBy String?
  createdAt DateTime @default(now())
}

model LessonMaterial {
  id          String   @id @default(cuid())
  sessionId   String
  session     SessionRecord @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  title       String
  filename    String
  url         String
  contentType String?
  size        Int?
  createdBy   String?
  createdAt   DateTime @default(now())
}

model LatexSave {
  id         String   @id @default(cuid())
  sessionKey String
  userId     String?
  userEmail  String?
  title      String
  latex      String
  shared     Boolean  @default(false)
  filename   String?
  url        String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([sessionKey])
  @@index([sessionKey, userId])
}

model LearnerResponse {
  id         String   @id @default(cuid())
  sessionKey String
  userId     String
  userEmail  String?
  quizId     String   @default("default")
  quizLabel  String?
  quizPhaseKey String?
  quizPointId String?
  quizPointIndex Int?
  prompt     String?
  latex      String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([sessionKey, userId, quizId])
  @@index([sessionKey])
  @@index([sessionKey, updatedAt])
  @@index([sessionKey, userId, updatedAt])
  @@index([sessionKey, quizPhaseKey, quizPointIndex, updatedAt])
}

model Diagram {
  id         String   @id @default(cuid())
  sessionKey String
  title      String   @default("")
  imageUrl   String
  order      Int      @default(0)
  annotations Json?
  createdBy  String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([sessionKey])
}

model DiagramSessionState {
  sessionKey      String  @id
  activeDiagramId String?
  isOpen          Boolean @default(true)
  updatedAt       DateTime @updatedAt
}

model SubscriptionPlan {
  id            String   @id @default(cuid())
  name          String
  amount        Int
  currency      String   @default("zar")
  stripePriceId String?
  payfastPlanId String?
  active        Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

enum VerificationKind {
  EMAIL
  PHONE
}

model ContactVerification {
  id         String            @id @default(cuid())
  userId     String
  user       User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  kind       VerificationKind
  tokenHash  String            @unique
  expiresAt  DateTime
  consumedAt DateTime?
  createdAt  DateTime          @default(now())
}
